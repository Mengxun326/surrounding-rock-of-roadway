# 巷道围岩监测系统

## 项目简介
这是一个基于Qt开发的巷道围岩监测系统，用于实时监测和分析巷道围岩的状态。该系统提供了传感器配置、数据采集、数据查询和预警等功能，帮助用户有效监控巷道安全状况。

### 系统特点
- **双通信模式**: 支持TCP和UDP两种通信协议
- **光纤光栅技术**: 集成光纤光栅分析软件模拟器
- **实时数据处理**: 支持应变、位移、温度等多种物理量计算
- **数据可视化**: 提供实时图表显示和历史数据查询
- **智能预警**: 基于阈值的自动预警系统
- **多传感器支持**: 支持多种类型传感器的配置和管理

## 开发环境与工具
### 开发工具
- Qt Creator 11.0.2 或更高版本
- Visual Studio 2019/2022（推荐使用2022）
- CMake 3.27.0 或更高版本
- Git 版本控制工具

### IDE 配置要求
- Qt Creator:
  - 中文语言包
  - Qt Design Studio 集成
  - Qt Charts 模块
  - Qt Network 模块
  - Qt SQL 模块

### 编译器
- MSVC 2019/2022 (x64)
- MinGW 11.2.0 64-bit（可选）

### 开发语言
- C++17
- Qt 6.5.0+

### 数据库
- MySQL 8.0+
- SQLite 3.0+（用于本地数据存储）

## 运行环境要求
### 操作系统
- Windows 10 22H2 (19045.3803) 或更高版本
- Windows 11 22H2 (22621.2428) 或更高版本

### 系统配置要求
- CPU: Intel Core i5 8代或更高/AMD Ryzen 5 3代或更高
- 内存: 8GB RAM 或更高
- 存储空间: 至少2GB可用空间
- 显示器: 1920x1080分辨率或更高

### 依赖组件
- Microsoft Visual C++ Redistributable 2019/2022
- .NET Framework 4.8或更高版本
- OpenGL 4.3或更高版本

## 主要功能

### 1. 核心监测系统 (Qt应用)
- **传感器管理**
  - 传感器配置和设计
  - 模块配置管理
  - 多类型传感器支持
- **数据监测**
  - 实时数据采集和显示
  - TCP/UDP双通信模式
  - 数据可视化图表
- **数据查询**
  - 历史数据查询和分析
  - 数据导出功能
  - 报表生成
- **预警系统**
  - 实时预警监控
  - 预警阈值配置
  - 预警记录管理
- **系统设置**
  - 基础参数配置
  - 系统维护功能

### 2. 光纤光栅模拟器 (Python)
- **通信协议支持**
  - TCP通信 (端口5555): JSON格式实时数据
  - UDP通信 (端口6666): 二进制格式振动数据
  - 心跳机制: 每30秒发送心跳包
- **数据处理**
  - 应变计算: 根据波长变化计算微应变(με)
  - 位移计算: 根据波长变化计算位移值
  - 温度计算: 根据波长变化计算温度值
  - 数据分类: 自动分类传感器类型
- **CSV数据支持**
  - 支持CSV文件数据导入
  - 实时数据发送
  - 数据格式验证

## 项目结构
```
surrounding-rock-of-roadway/
├── data/                    # 数据文件目录
│   ├── config/             # 配置文件
│   ├── db/                 # 数据库文件
│   └── logs/               # 日志文件
├── fonts/                  # 字体资源
├── icons/                  # 图标资源
├── imgs/                   # 图片资源
├── out/                    # 输出目录
│   ├── debug/              # 调试版本
│   └── release/            # 发布版本
├── 核心Qt应用文件/
│   ├── *.cpp               # C++源文件
│   ├── *.h                 # 头文件
│   ├── *.ui                # Qt界面文件
│   └── surrounding-rock-of-roadway.pro  # Qt项目文件
├── Python模拟器和测试/
│   ├── fiber_bragg_simulator.py         # 光纤光栅模拟器
│   ├── test_chart_display.py            # 图表显示测试
│   ├── test_client.py                   # TCP客户端测试
│   ├── test_data_sending.py            # 数据发送测试
│   ├── test_network_connection.py      # 网络连接测试
│   ├── test_strain_calculation.py      # 应变计算测试
│   └── CH8_Day_20250831114240.csv      # 测试数据文件
├── 文档/
│   ├── README.md                        # 项目说明文档
│   ├── 光纤光栅模拟器使用说明.md        # 模拟器使用说明
│   ├── 通信协议实现说明.md              # 通信协议文档
│   ├── 应变数据修正说明.md              # 数据修正说明
│   └── 基于光纤传感技术的巷道围岩监测系统平台_用户手册.docx
└── 资源文件/
    ├── res.qrc              # Qt资源文件
    ├── logo.ico             # 应用图标
    └── surrounding-rock-of-roadway_zh_CN.ts  # 中文翻译文件
```

## 构建和运行
### 开发环境配置
1. 安装Visual Studio 2022
   - 选择"使用C++的桌面开发"工作负载
   - 安装Windows 10/11 SDK
   
2. 安装Qt开发环境
   - 下载并安装Qt Online Installer
   - 选择Qt 6.5.0或更高版本
   - 安装对应的MSVC编译器组件
   - 安装Qt Charts、Qt Network等附加模块

3. 配置Qt Creator
   - 配置编译器和调试器
   - 配置Qt套件(Kit)
   - 安装中文语言包（可选）

### 项目配置
1. 克隆项目
```bash
git clone [项目地址]
cd surrounding-rock-of-roadway
```

2. 打开项目
   - 使用Qt Creator打开`surrounding-rock-of-roadway.pro`文件
   - 配置项目构建套件
   - 选择编译模式（Debug/Release）

3. 构建项目
   - 点击构建按钮或按Ctrl+B
   - 等待构建完成

4. 运行项目
   - 点击运行按钮或按Ctrl+R
   - 检查运行日志

### Python模拟器使用
1. 安装Python环境
   ```bash
   # 确保Python 3.7+已安装
   python --version
   ```

2. 运行光纤光栅模拟器
   ```bash
   # 使用默认CSV文件
   python fiber_bragg_simulator.py
   
   # 指定CSV文件
   python fiber_bragg_simulator.py CH8_Day_20250831114240.csv
   ```

3. 运行测试脚本
   ```bash
   # 应变计算测试
   python test_strain_calculation.py
   
   # 网络连接测试
   python test_network_connection.py
   
   # 数据发送测试
   python test_data_sending.py
   ```

### 数据库配置
1. 安装MySQL数据库
2. 创建数据库和表
3. 配置数据库连接参数
4. SQLite数据库自动创建（用于本地存储）

## 功能模块说明
### 传感器配置模块
- 支持多种类型传感器的配置
- 提供传感器参数设置界面
- 支持传感器布局设计
- 支持传感器数据校准

### 数据采集模块
- 实时数据采集和显示
- 数据存储和管理
- 支持多通道数据采集
- 采集频率可配置
- 数据预处理功能

### 查询分析模块
- 历史数据查询和分析
- 数据导出功能（支持Excel、CSV格式）
- 数据可视化展示
- 趋势分析
- 报表生成

### 预警系统
- 实时监测预警
- 预警阈值设置
- 预警信息推送
- 预警级别管理
- 预警记录查询

## 日志系统
系统集成了完整的日志记录功能，所有操作和异常都会被记录在`log.log`文件中，包含以下级别的日志：
- Debug: 调试信息
- Info: 一般信息
- Warning: 警告信息
- Critical: 严重错误
- Fatal: 致命错误

## 通信协议

### TCP通信 (端口5555)
- **数据格式**: JSON格式实时数据
- **心跳机制**: 每30秒发送心跳包，超时35秒自动断开
- **数据内容**: 应变、位移、温度、波长等传感器数据
- **连接管理**: 支持自动重连和连接状态监控

### UDP通信 (端口6666)
- **数据格式**: 二进制格式振动数据
- **启动命令**: `FFFFFFFFEEEEEEEE` 十六进制命令
- **数据内容**: 振动传感器波长和频率数据
- **分包传输**: 支持大数据包的分包传输和组包

### 数据格式示例
```json
{
  "type": 0,
  "sync": "sync header timestamp",
  "body": {
    "VER": "1.0",
    "MSG": "REALTIME",
    "ERR": 0,
    "PARAM": {
      "Strain": [{"ChNum": 1, "ID": "00101", "Name": "传感器1_应变", "Val": "15.24"}],
      "WL": [[1, "1535.9597"], [2, "1553.7931"]]
    }
  }
}
```

## 数据库
系统使用多种数据库进行数据存储和管理：

### MySQL数据库
- 传感器数据存储
- 配置信息管理
- 历史记录查询
- 用户管理
- 权限控制

### SQLite数据库
- 本地数据缓存
- 振动数据存储 (`vibration_data.db`)
- 传感器数据存储 (`sensor_data.db`)
- 连接日志记录 (`connection_log`)

## 注意事项
1. 首次运行前请确保数据库配置正确
2. 定期备份重要数据
3. 请定期检查系统日志
4. 确保所有传感器配置正确后再开始数据采集
5. 建议使用推荐的开发环境和工具版本
6. 确保系统时间准确
7. 定期清理日志文件
8. 使用杀毒软件时，建议将程序目录添加到白名单

## 故障排除

### Qt应用问题
1. **数据库连接失败**
   - 检查数据库服务是否启动
   - 验证连接参数是否正确
   - 确认网络连接状态

2. **传感器无法连接**
   - 检查硬件连接
   - 验证传感器配置
   - 检查驱动程序

3. **程序启动失败**
   - 检查依赖组件是否安装
   - 验证配置文件完整性
   - 查看错误日志

### Python模拟器问题
1. **连接问题**
   - 检查监测系统是否运行在 `192.168.3.90:5555` 和 `192.168.3.90:6666`
   - 确认防火墙设置允许端口访问
   - 验证网络连接状态

2. **数据问题**
   - 确认CSV文件格式正确（时间戳,波长,传感器名称,物理量）
   - 检查波长数据是否在合理范围内
   - 验证时间戳格式

3. **应变计算问题**
   - 检查应变系数K1设置（默认3.0）
   - 验证初始波长设置（默认1537.2540 nm）
   - 确认应变值范围（-50到50 με）

4. **编码问题**
   - 确保CSV文件使用UTF-8编码
   - 检查中文字符显示
   - 验证文件路径无特殊字符

### 端口占用问题
```bash
# Windows检查端口占用
netstat -ano | findstr :5555
netstat -ano | findstr :6666

# Linux检查端口占用
netstat -tulpn | grep :5555
netstat -tulpn | grep :6666
```

## 联系与支持

### 技术支持
如有问题或建议，请联系系统管理员或技术支持人员：
- 技术支持邮箱：[support@example.com]
- 问题反馈地址：[项目Issue地址]
- 文档地址：[文档链接]

### 相关文档
- [光纤光栅模拟器使用说明](光纤光栅模拟器使用说明.md)
- [通信协议实现说明](通信协议实现说明.md)
- [应变数据修正说明](应变数据修正说明.md)
- [基于光纤传感技术的巷道围岩监测系统平台_用户手册.docx](基于光纤传感技术的巷道围岩监测系统平台_用户手册.docx)

### 测试工具
项目提供了完整的测试工具集：
- `test_strain_calculation.py` - 应变计算功能测试
- `test_network_connection.py` - 网络连接测试
- `test_data_sending.py` - 数据发送测试
- `test_chart_display.py` - 图表显示测试
- `test_client.py` - TCP客户端测试

### 版本信息
- **Qt应用版本**: 基于Qt 6.5.0+
- **Python模拟器版本**: Python 3.7+
- **通信协议版本**: 1.0
- **数据库版本**: MySQL 8.0+ / SQLite 3.0+
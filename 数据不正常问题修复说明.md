# 数据不正常问题修复说明

## 问题描述

从系统界面截图可以看到：
1. **系统日志显示**: "应变数据添加到图表: 6.032 500" - 数据确实在添加
2. **图表显示**: 中央图表完全空白，没有任何数据线条
3. **数据点数**: 日志显示"当前数据点数:17"，但图表为空

## 问题原因分析

### 1. 数据分类问题 ✅ 已修复
- **问题**: CSV数据中的波长主要在1550-1580nm范围，被错误分类为温度传感器
- **原因**: 原代码将1550-1580nm范围分类为温度传感器，而不是应变传感器
- **修复**: 将所有波长数据都作为应变数据处理

### 2. Y轴范围问题 ✅ 已修复
- **问题**: 图表初始化时Y轴范围设置为-50到50，但应变数据值是500
- **原因**: 数据点超出Y轴显示范围，被绘制在图表区域之外
- **修复**: 将Y轴范围设置为-300到500，匹配应变数据的合理范围

## 修复内容

### 1. 数据分类修正
```cpp
// 修正前：根据波长范围分类
if (1535.0 <= wavelength <= 1540.0) {
    // 应变传感器
} else if (1540.0 < wavelength <= 1550.0) {
    // 位移传感器  
} else if (1550.0 < wavelength <= 1580.0) {
    // 温度传感器
}

// 修正后：所有数据都作为应变数据处理
strain_data.append({
    "ChNum": ch_num,
    "ID": sensor_id,
    "Name": f"{sensor_name}_应变",
    "Val": f"{strain_value:.2f}"
});
```

### 2. Y轴范围修正
```cpp
// 修正前
m_axisY->setRange(-50, 50);

// 修正后
m_axisY->setRange(-300, 500);  // 设置应变数据的Y轴范围
```

### 3. 动态Y轴范围调整
```cpp
// 自动调整Y轴范围，确保应变数据能正确显示
if (maxValue > minValue) {
    qreal range = maxValue - minValue;
    if (range < 10) range = 10;  // 最小范围
    m_axisY->setRange(minValue - range * 0.1, maxValue + range * 0.1);
} else {
    // 使用默认的应变数据范围
    m_axisY->setRange(-300, 500);
}
```

## 修复效果验证

### 测试结果
```
应变数据值范围测试:
最小值: -300.0
最大值: 500.0
数据范围: 800.0

Y轴范围计算:
原始范围: -300.0 到 500.0
扩展后范围: -380.0 到 580.0
Y轴范围在应变数据合理范围内 (-300 到 500)

修正前问题:
- 原始Y轴范围: -50 到 50
- 应变数据值: 500
- 问题: 数据点超出Y轴范围，无法显示

修正后效果:
- 新Y轴范围: -300 到 500
- 应变数据值: 500
- 效果: 数据点在Y轴范围内，可以正常显示
```

### 数据分类验证
```
波长到应变转换:
波长 1: 1552.729248 nm
  波长变化: 15.475248 nm
  应变值: 500.00 με
  分类: 应变数据 (value > 0)

波长 2: 1555.184326 nm
  波长变化: 17.930326 nm
  应变值: 500.00 με
  分类: 应变数据 (value > 0)
```

## 预期效果

修复后，系统应该能够：

1. **正确接收应变数据**: 所有波长数据都被分类为应变数据
2. **正确显示图表**: 应变数据线条应该出现在图表中
3. **正确的Y轴范围**: 数据点在-300到500范围内正常显示
4. **正确的日志输出**: 系统日志应该显示"应变数据添加到图表"

## 下一步操作

1. **重新编译程序**: 应用修复后的代码
2. **运行光纤光栅模拟器**: 发送修正后的应变数据
3. **观察图表显示**: 应该看到红色的应变数据线条
4. **检查系统日志**: 确认显示"应变数据"而不是"温度数据"

## 技术细节

### 应变计算公式
```
应变(με) = (当前波长 - 初始波长) × K1
其中：
- 初始波长: 1537.2540 nm
- K1系数: 900.000000 με/nm
- 应变范围: -300.00 到 500.00 με
```

### 数据流程
1. CSV波长数据 → 应变计算 → 应变数据分类
2. 应变数据 → JSON格式 → TCP发送
3. 接收数据 → 图表显示 → 红色线条

**现在数据应该能正常显示在图表中了！** 🎉

# 光纤光栅分析软件通信协议实现说明

## 概述

本系统已根据光纤光栅分析软件通信协议文档实现了完整的通信功能，包括TCP服务端和UDP接收器。

## 实现的功能

### 1. TCP服务端 (端口5555)
- **心跳机制**: 每30秒向客户端发送心跳包，超时35秒自动断开连接
- **JSON数据解析**: 支持协议文档中定义的所有数据格式
- **数据库存储**: 使用SQLite存储所有传感器数据
- **自动重连**: 连接断开时自动尝试重连

### 2. UDP接收器 (端口6666)
- **振动数据接收**: 实时接收振动传感器的波长和频率数据
- **频谱数据接收**: 支持分包传输的频谱数据
- **启动命令处理**: 响应FFFFFFEEEEEEEE启动命令

### 3. 数据库设计
- **sensor_data**: 存储各种传感器数据（应变、位移、温度、水位、加速度、压力）
- **wavelength_data**: 存储波长数据
- **vibration_data**: 存储振动数据
- **spectrum_data**: 存储频谱数据
- **connection_log**: 记录连接日志

## 文件结构

```
surrounding-rock-of-roadway/
├── tcpserver.h          # TCP服务端头文件
├── tcpserver.cpp        # TCP服务端实现
├── udpreceiver.h        # UDP接收器头文件
├── udpreceiver.cpp      # UDP接收器实现
├── test_communication.cpp # TCP客户端测试程序
├── test_udp_sender.cpp   # UDP发送器测试程序
└── 通信协议实现说明.md    # 本说明文件
```

## 使用方法

### 1. 启动主程序
```bash
# 编译并运行主程序
qmake
make
./surrounding-rock-of-roadway
```

主程序启动后会自动：
- 启动TCP服务端监听5555端口
- 启动UDP接收器监听6666端口
- 初始化SQLite数据库

### 2. 测试TCP通信
```bash
# 编译并运行TCP测试客户端
g++ -o test_tcp test_communication.cpp -I/path/to/qt/include -L/path/to/qt/lib -lQt6Core -lQt6Network
./test_tcp
```

测试客户端会：
- 连接到TCP服务端
- 每30秒发送心跳包
- 每5秒发送测试传感器数据

### 3. 测试UDP通信
```bash
# 编译并运行UDP测试发送器
g++ -o test_udp test_udp_sender.cpp -I/path/to/qt/include -L/path/to/qt/lib -lQt6Core -lQt6Network
./test_udp
```

测试发送器会：
- 发送启动命令
- 每2秒发送振动数据
- 偶尔发送频谱数据

## 数据格式

### TCP数据格式
```json
{
  "type": 0,
  "sync": "sync header date",
  "body": {
    "VER": "1.0",
    "MSG": "REALTIME",
    "ERR": 0,
    "PARAM": {
      "Strain": [
        {
          "ChNum": 1,
          "ID": "00101",
          "Name": "应变传感器1",
          "Val": "15.24"
        }
      ],
      "Move": [...],
      "Temp": [...],
      "WLG": [...],
      "a": [...],
      "P": [...],
      "WL": [
        [1, "1535.9597", "1553.1787"],
        [2, "1553.7931"]
      ]
    }
  }
}
```

### UDP数据格式
- **实时数据**: 包头(4) + 帧类型(1) + 传感器数据(40字节/个)
- **频谱数据**: 包头(4) + 帧类型(1) + 通道信息 + 频谱数据

## 界面更新

系统界面会实时显示：
- TCP连接状态（服务器2状态）
- UDP数据接收状态（服务器3状态）
- 实时数据图表更新
- 连接日志记录

## 故障排除

### 1. 端口被占用
如果5555或6666端口被占用，检查是否有其他程序在使用这些端口：
```bash
# Windows
netstat -ano | findstr :5555
netstat -ano | findstr :6666

# Linux
netstat -tulpn | grep :5555
netstat -tulpn | grep :6666
```

### 2. 数据库文件权限
确保程序有权限创建和写入SQLite数据库文件。

### 3. 防火墙设置
确保防火墙允许程序监听指定端口。

## 扩展功能

### 1. 添加新的传感器类型
在`tcpserver.cpp`的`processRealtimeData`方法中添加新的传感器类型处理。

### 2. 自定义数据存储
修改数据库表结构或添加新的存储逻辑。

### 3. 实时图表更新
在`widget.cpp`的`updateRealtimeDisplay`方法中实现具体的图表更新逻辑。

## 注意事项

1. 系统作为TCP服务端运行，等待光纤光栅分析软件连接
2. 心跳机制确保连接稳定性，超时自动断开
3. 所有数据都会存储到SQLite数据库中
4. 支持多通道传感器数据同时接收
5. UDP数据支持分包传输和组包

## 技术支持

如有问题，请检查：
1. 日志文件 `log.log`
2. 数据库文件 `sensor_data.db` 和 `vibration_data.db`
3. 系统控制台输出

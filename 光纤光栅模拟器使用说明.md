# 光纤光栅分析软件模拟器使用说明

## 概述

本模拟器根据通信协议文档，模拟光纤光栅分析软件向监测系统发送CSV数据。支持TCP和UDP两种通信方式，能够正确计算应变数据并发送到监测系统。

## 功能特点

### 1. 通信协议支持
- **TCP通信** (端口5555): 发送JSON格式的实时数据
- **UDP通信** (端口6666): 发送二进制格式的振动数据
- **心跳机制**: 每30秒发送TCP心跳包
- **启动命令**: 发送UDP启动命令 `FFFFFFFFEEEEEEEE`

### 2. 数据计算
- **应变计算**: 根据波长变化计算微应变(με)
- **位移计算**: 根据波长变化计算位移值
- **温度计算**: 根据波长变化计算温度值
- **数据分类**: 根据波长范围自动分类传感器类型

### 3. 应变计算参数
- **初始波长**: 1537.2540 nm
- **应变系数 K1**: 900.000000 με/nm
- **计算公式**: 应变(με) = (当前波长 - 初始波长) × K1
- **Y轴范围**: -300.00 到 500.00 με
- **波长变化范围**: -0.33 到 +0.56 nm

## 使用方法

### 1. 基本使用
```bash
# 使用默认CSV文件
python fiber_bragg_simulator.py

# 指定CSV文件
python fiber_bragg_simulator.py CH8_Day_20250831114240.csv
```

### 2. 配置参数
在脚本中可以修改以下参数：
```python
# 目标地址配置
host = '192.168.3.90'      # 监测系统IP地址
tcp_port = 5555            # TCP端口
udp_port = 6666            # UDP端口

# 应变计算参数
initial_wavelength = 1537.2540  # 初始波长
K1 = 900.000000                # 应变系数
```

### 3. CSV数据格式
CSV文件应包含以下列：
- 第1列: 时间戳
- 第2列开始: 波长数据（每3列为一组：波长,传感器名称,物理量）

示例：
```csv
时间,波长,传感器名称,物理量,波长,传感器名称,物理量
2025-08-31 11:42:50.731,1552.729248,0,0,1555.184326,0,0
2025-08-31 11:43:00.731,1554.069580,0,0
```

## 数据分类规则

### 传感器类型分类
根据波长范围自动分类：

1. **应变传感器** (1535.0 - 1540.0 nm)
   - 计算应变值(με)
   - 范围: -300.00 到 500.00

2. **位移传感器** (1540.0 - 1550.0 nm)
   - 计算位移值
   - 放大系数: 1000

3. **温度传感器** (1550.0 - 1580.0 nm)
   - 计算温度值
   - 放大系数: 100

## TCP数据格式

### 实时数据包
```json
{
  "type": 0,
  "sync": "sync header timestamp",
  "body": {
    "VER": "1.0",
    "MSG": "REALTIME",
    "ERR": 0,
    "PARAM": {
      "Strain": [
        {
          "ChNum": 1,
          "ID": "00101",
          "Name": "传感器1_应变",
          "Val": "15.24"
        }
      ],
      "Move": [...],
      "Temp": [...],
      "WLG": [],
      "a": [],
      "P": [],
      "WL": [
        [1, "1535.9597"],
        [2, "1553.7931"]
      ]
    }
  }
}
```

### 心跳包
```json
{
  "type": 1,
  "sync": "heartbeat",
  "body": {
    "VER": "1.0",
    "MSG": "HEARTBEAT",
    "ERR": 0,
    "PARAM": {}
  }
}
```

## UDP数据格式

### 启动命令
- 十六进制: `FFFFFFFFEEEEEEEE`
- 用途: 启动UDP数据接收

### 传感器数据包
- 包头: 4字节 (0x12345678)
- 帧类型: 1字节 (0x01)
- 传感器数据: 每个传感器40字节
  - 波长: 8字节 (double)
  - 频率: 8字节 (double)
  - 其他数据: 24字节

## 测试功能

### 应变计算测试
```bash
python test_strain_calculation.py
```

测试结果示例：
```
测试应变计算功能
==================================================
波长(nm)      波长变化(nm)    应变(με)      状态        
--------------------------------------------------
1537.254000  0.000000     0.00        正常        
1536.254000  -1.000000    -300.00     正常        
1538.254000  1.000000     500.00      正常        
```

## 故障排除

### 1. 连接问题
- 检查监测系统是否运行
- 确认IP地址和端口配置正确
- 检查防火墙设置

### 2. 数据问题
- 确认CSV文件格式正确
- 检查波长数据是否在合理范围内
- 验证时间戳格式

### 3. 编码问题
- 确保CSV文件使用UTF-8编码
- 检查中文字符显示

## 注意事项

1. **数据范围**: 应变值会自动限制在-300.00到500.00范围内
2. **时间间隔**: 默认每秒发送一次数据，可根据需要调整
3. **连接稳定性**: 心跳机制确保TCP连接稳定
4. **数据完整性**: 所有波长数据都会发送，包括WL字段

## 技术支持

如有问题，请检查：
1. 日志输出信息
2. 网络连接状态
3. CSV数据格式
4. 监测系统运行状态
